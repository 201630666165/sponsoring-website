/*© yizanzhu.com*/function UploadImage(e,i,t){navigator.userAgent.indexOf("Trident")!==-1&&$("#ie-paste-fix").hide();var n={dnd:!0,paste:!0,preview:!0,$element:t.$element,success:function(){}},a=$.extend(n,t),o=$(window),d=800,c=472,f=520,s=a.$element,l=$("#event-poster-modal"),r=l.find(".modal-dialog"),p=l.find(".modal-body"),g={},u=e/d,m={x:0,y:0,w:e,h:i},h=function(e){var i=FileAPI.getFiles(e);i.length&&F(i[0]),FileAPI.reset(e.target)},v=function(t,n){var a=t.width,s=t.height;if(a<e||s<i)return PopupMessage(1,"图片尺寸不可小于 "+e+"*"+i+"px",2e3);var m,h=d;u=a/d,m=s/u,m>=c?(m=c,u=s/c,h=a/u,h<f?(r.css({width:f}),p.css({paddingLeft:(f-h)/2})):(r.css({width:d}),p.css({paddingLeft:(d-h)/2})),p.css({paddingTop:0})):(r.css({width:d}),p.css({paddingTop:(c-m)/2,paddingLeft:0})),FileAPI.Image(n).resize(h,m).get(function(t,d){if(!t){r.css({marginTop:(o.outerHeight()-544)/2}),p.html(d),l.data("bs.modal")&&l.data("bs.modal").isShown||l.modal({backdrop:"static"}),g=$.extend({file:n},{width:a,height:s});var c=e/u,f=i/u;$.Jcrop(d,{aspectRatio:e/i,minSize:[c,f],setSelect:[(h-c)/2,(m-f)/2,(h-c)/2+c,(m-f)/2+f],onChange:function(e){w(e)},onSelect:function(e){w(e)}})}})},w=function(e){$.each(e,function(e,i){m[e]=i*u})};if(a.preview){var I=$("#poster-preview"),P=function(e){FileAPI.Image(e).preview(472,280).get(function(e,i){e||I.html(i)})};I.on("click","canvas",function(){l.modal()})}var A=function(){var t=function(e){l.modal("hide"),a.before&&a.before(e.toDataURL("image/jpeg",.9),function(){a.preview&&P(e),a.success()})};return function(n,a){a?FileAPI.Image(n).crop(a.x<0?0:a.x,a.y<0?0:a.y,a.w>e?a.w:e,a.h>i?a.h:i).get(function(e,i){e||t(i)}):FileAPI.Image(n).preview(g.width,g.width/(e/i)).get(function(e,i){e||t(i)})}}(),F=function(e){return g.file&&e.lastModified===g.file.lastModified&&e.size===g.file.size?l.modal():e.type.indexOf("image")===-1?PopupMessage(1,"上传文件类型只能是图片",2e3):e.size>4*FileAPI.MB?PopupMessage(1,"上传文件必须小于4M",2e3):void FileAPI.getInfo(e,function(i,t){i||v(t,e)})};if(FileAPI.support.dnd&&a.dnd){var x=s.find(".drop-zone");$(document).dnd(function(e){x.toggle(e)},function(){}),s.dnd(function(e){},function(e){return e.length>1?PopupMessage(1,"1次只能上传1个文件",2e3):void F(e[0])})}s.find("[type=file]").change(h),a.paste&&document.addEventListener("paste",function(e){var i=e.clipboardData;i.items&&i.items.length&&(temp=[].filter.call(i.items,function(e){return e.type.indexOf("image")!==-1}),temp.length&&FileAPI.readAsDataURL(temp[0].getAsFile(),function(e){var i=FileAPI.newImage(e.result);v({width:i.width,height:i.height},FileAPI.Image.toCanvas(i))}))}),l.find(".btn-primary").click(function(e){e.preventDefault(),A(g.file,0==m.w?void 0:m)}),l.find(".pull-right").click(function(){l.modal("hide"),s.find("[type=file]").trigger("click")})}